{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container py-4">
    <h1 class="mb-4 text-white">Search Torrents</h1>

    <!-- Download Button -->
    <div class="d-flex mb-3">        <select id="filterSource" class="form-select form-select-sm me-2" style="width:auto;">
            <option value="all">All Sources</option>
            {% for src in sources %}
            <option value="{{ src }}" {% if filter_source == src %}selected{% endif %}>{{ src }}</option>
            {% endfor %}
        </select>
        <select id="sortBy" class="form-select form-select-sm me-2" style="width:auto;">
            <option value="seeders">Seeds</option>
            <option value="leechers">Leechers</option>
            <option value="size">Size</option>
            <option value="title">Name</option>
        </select>
        <button id="sortDirBtn" class="btn btn-sm btn-light me-2">üìâ</button>
        <button id="bulkDownloadBtn" class="btn btn-danger btn-sm me-2" disabled>‚¨á Download</button>
    </div>    <!-- Search Input -->
    <div class="input-group mb-3 search-container">        <span class="input-group-text bg-dark border-secondary">
            <i class="fas fa-search text-white"></i>
        </span>
        <input type="text" id="searchQuery" class="form-control form-control-sm bg-dark text-white border-secondary" 
            placeholder="Search Torrents..." autocomplete="off" value="{{ initial_query }}" />
        <button id="clearSearchBtn" class="btn btn-sm btn-outline-secondary" type="button" style="display: none;">
            <i class="fas fa-times"></i>
        </button>
        <button id="searchBtn" class="btn btn-sm btn-primary">Search</button>
    </div>

    <!-- Scroll Container -->
    <div id="scrollArea" style="max-height:600px; overflow-y:auto;">
        <ul id="contentArea" class="list-unstyled mb-0">
            <!-- rows injected here -->
        </ul>
    </div>
</div>
{% endblock %}


{% block extra_scripts %}
<style>
    .search-container {
        max-width: 100%;
        position: relative;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        border-radius: 5px;
        overflow: hidden;
    }
    
    #searchQuery:focus {
        box-shadow: none;
        border-color: var(--bs-primary) !important;
    }
    
    .search-container .form-control::placeholder {
        opacity: 0.7;
    }
    
    .search-results-highlight {
        transition: all 0.3s ease;
        border-left: 3px solid var(--bs-primary) !important;
    }
</style>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    let allResults = [],
        isLoading = false,
        sortAsc = false;
    const selected = new Set();

    /*‚Äì‚Äì UTILITY FUNCTIONS ‚Äì‚Äì*/
    function formatSize(sizeStr) {
        const [num, unit] = sizeStr.split(' ');
        const n = parseFloat(num) || 0;
        if (unit === 'GB') return n * 1024;
        if (unit === 'KB') return n / 1024;
        return n;
    }    function renderRow(r) {
        const sel = selected.has(r.link) ? 'bg-info bg-opacity-75 text-dark' : '';
        const logo = "{% static 'sourceLogos/' %}" + r.source + ".png";
        return `
        <li class="p-2 mb-2 text-white border border-secondary rounded d-flex align-items-center ${sel} search-results-highlight"
            data-link="${r.link}" style="cursor:pointer;">
          <img src="${logo}" width="24" class="me-2" alt="${r.source} logo"/>
          <div class="flex-grow-1">
            <h6 class="mb-1 text-truncate" title="${r.title}">${r.title}</h6>
            <div class="d-flex justify-content-between">
              <small>${r.source} ‚Ä¢ ${r.size}</small>
              <small><i class="fas fa-arrow-up text-success"></i> ${r.seeders} <i class="fas fa-arrow-down text-danger ms-2"></i> ${r.leechers}</small>
            </div>
          </div>
        </li>`;
    }

    function getViewList() {
        const filter = $('#filterSource').val().toLowerCase();
        const key = $('#sortBy').val();
        return allResults
            .filter(r => filter === 'all' || r.source.toLowerCase() === filter)
            .sort((a, b) => {
                let va, vb;
                if (key === 'size') {
                    va = formatSize(a.size);
                    vb = formatSize(b.size);
                } else if (key === 'seeders' || 'leechers') {
                    va = +a[key] || 0;
                    vb = +b[key] || 0;
                } else {
                    va = a.title.toLowerCase();
                    vb = b.title.toLowerCase();
                }
                return sortAsc ? va - vb : vb - va;
            });
    }    function fullRender() {
        const $c = $('#contentArea');
        $c.empty();
        const q = $('#searchQuery').val().trim();
        
        if (!q) {
            return $c.append('<li class="text-center text-white p-4"><i class="fas fa-search fa-2x mb-3"></i><p>Type something to start searching</p></li>');
        }
        
        if (isLoading) {
            return $c.append('<li class="text-center text-white p-4"><div class="spinner-border text-light mb-3" role="status"><span class="visually-hidden">Loading...</span></div><p>Searching for "' + q + '"...</p></li>');
        }
        
        if (!allResults.length) {
            return $c.append('<li class="text-center text-white p-4"><i class="fas fa-exclamation-circle fa-2x mb-3"></i><p>No results found for "' + q + '"</p></li>');
        }
        
        const view = getViewList();
        if (!view.length) {
            return $c.append('<li class="text-center text-white p-4"><i class="fas fa-filter fa-2x mb-3"></i><p>No matches with current filters</p></li>');
        }
        
        view.forEach(r => $c.append(renderRow(r)));
    }    function doSearch() {
        const q = $('#searchQuery').val().trim();
        if (!q) return;
        
        // Show search in progress
        allResults = [];
        selected.clear();
        $('#bulkDownloadBtn').prop('disabled', true);
        isLoading = true;
        fullRender();
        
        // Add loading indicator to search button
        const $searchBtn = $('#searchBtn');
        const originalText = $searchBtn.html();
        $searchBtn.html('<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>').prop('disabled', true);
        
        // Add animation to search container
        $('.search-container').addClass('border-primary');

        $.getJSON(
                `/search/api/?query=${encodeURIComponent(q)}&filterSource=${encodeURIComponent($('#filterSource').val())}`
                )
            .done(data => {
                allResults = data.results;
                
                // Highlight the search input for a moment to show success
                if (allResults.length > 0) {
                    $('#searchQuery').addClass('border-success');
                    setTimeout(() => $('#searchQuery').removeClass('border-success'), 1000);
                } else {
                    $('#searchQuery').addClass('border-warning');
                    setTimeout(() => $('#searchQuery').removeClass('border-warning'), 1000);
                }
            })
            .fail(() => {
                showAlert('‚ùå Search failed. Please try again.');
                $('#searchQuery').addClass('border-danger');
                setTimeout(() => $('#searchQuery').removeClass('border-danger'), 1000);
            })
            .always(() => {
                isLoading = false;
                $searchBtn.html(originalText).prop('disabled', false);
                $('.search-container').removeClass('border-primary');
                fullRender();
            });
    }

    function updateBulkBtn() {
        $('#bulkDownloadBtn').prop('disabled', !selected.size);
    }


    /*‚Äì‚Äì CUSTOM MODALS ‚Äì‚Äì*/
    function showAlert(msg, onClose) {
        const el = document.getElementById('alertModal');
        el.querySelector('#alertModalMessage').textContent = msg;
        const modal = new bootstrap.Modal(el);
        if (onClose) {
            el.addEventListener('hidden.bs.modal', function handler() {
                el.removeEventListener('hidden.bs.modal', handler);
                onClose();
            });
        }
        modal.show();
    }

    function showConfirm(msg, callback) {
        const el = document.getElementById('confirmModal');
        el.querySelector('#confirmModalMessage').textContent = msg;
        const modal = new bootstrap.Modal(el);

        // Clear previous handlers
        const okBtn = el.querySelector('#confirmBtn');
        const cancelBtn = el.querySelector('.btn-secondary');
        okBtn.replaceWith(okBtn.cloneNode(true));
        cancelBtn.replaceWith(cancelBtn.cloneNode(true));

        el.querySelector('#confirmBtn').addEventListener('click', () => {
            callback(true);
            modal.hide();
        });
        el.querySelector('.btn-secondary').addEventListener('click', () => {
            callback(false);
            modal.hide();
        });

        modal.show();
    }
    /*‚Äì‚Äì MAIN ‚Äî EVENTS ‚Äî INITIALIZE ‚Äì‚Äì*/
    $(function () {
        // Search related variables
        let searchTimeout;
        const SEARCH_DELAY = 500; // ms to wait before auto-searching
        
        // Handle search input
        $('#searchQuery').on('input', function() {
            const query = $(this).val().trim();
            
            // Show/hide clear button based on input
            $('#clearSearchBtn').toggle(query.length > 0);
            
            // Clear any pending search timeout
            clearTimeout(searchTimeout);
            
            // Set a new timeout for search
            if (query.length >= 2) {
                searchTimeout = setTimeout(doSearch, SEARCH_DELAY);
            }
        });
        
        // Clear search button
        $('#clearSearchBtn').click(function() {
            $('#searchQuery').val('').focus();
            $(this).hide();
            allResults = [];
            selected.clear();
            updateBulkBtn();
            fullRender();
        });
        
        $('#sortDirBtn').click(() => {
            sortAsc = !sortAsc;
            $('#sortDirBtn').text(sortAsc ? 'üìà' : 'üìâ');
            fullRender();
        });        $('#filterSource, #sortBy').change(fullRender);
        
        // Search button click
        $('#searchBtn').click(function(e) {
            e.preventDefault();
            doSearch();
        });
        
        // Enter key in search input
        $('#searchQuery').keydown(function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                doSearch();
            }
            
            // Escape key clears search
            if (e.key === 'Escape') {
                e.preventDefault();
                $('#clearSearchBtn').click();
            }
        });
          // Initialize search input state
        if ($('#searchQuery').val().trim().length > 0) {
            $('#clearSearchBtn').show();
            // Auto-search if a query is provided in the URL
            doSearch();
        }
        $('#contentArea').on('click', 'li', function () {
            const link = $(this).data('link');
            selected.has(link) ? selected.delete(link) : selected.add(link);
            updateBulkBtn();
            $(this).toggleClass('bg-info text-dark');
        });

        $('#bulkDownloadBtn').click(() => {
            if (!selected.size) return;
            const torrents = Array.from(selected).map(l => ({
                link: l
            }));
            $.ajax({
                url: '/search/download/',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    torrents
                }),
                success: () => {
                    // First show alert, then after it's closed ask confirm
                    showAlert('‚úÖ Torrents sent for download.', () => {
                        selected.clear();
                        updateBulkBtn();
                        fullRender();
                        showConfirm('Do you want to go check downloads?', ok => {
                            if (ok) window.location.href =
                                "{% url 'torrent' %}";
                        });
                    });
                },
                error: () => {
                    showAlert('‚ùå Failed to send torrents for download.');
                }
            });
        });

        fullRender();
    });
</script>

<!-- ALERT MODAL -->
<div class="modal fade" id="alertModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-dark">Alert</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="alertModalMessage" class="text-dark"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<!-- CONFIRM MODAL -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title text-dark">Confirm</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalMessage" class="text-dark"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="confirmBtn">Confirm</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}